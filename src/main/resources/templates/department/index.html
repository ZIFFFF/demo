<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>部门管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css">
</head>
<body>
<form class="layui-form">
    <table id="deptList" lay-filter="deptList" lay-skin="line"></table>

    <!--操作-->
    <script type="text/html" id="deptListBar">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn  layui-btn-xs " lay-event="usable">已启用</a>
        <a class="layui-btn layui-btn-primary layui-btn-xs " lay-event="del">删除</a>
    </script>
</form>
<script type="text/javascript" src="/layui/layui.js"></script>
<script type="text/javascript" src="/layui/lay/modules/treeTable.js"></script>
<script type="text/javascript">
    layui.use(['form', 'layer', 'table', 'treeTable', 'laytpl'], function () {
        var form = layui.form,
            layer = parent.layer === undefined ? layui.layer : top.layer,
            $ = layui.jquery,
            laytpl = layui.laytpl,
            table = layui.table,
            treeTable = layui.treeTable;

        //用户列表
        var tableIns = treeTable.render({
            elem: '#deptList',
            url: '/dept/list',
            cellMinWidth: 95,
            page: false,
            // height : "full-120",
            limits: [10, 15, 20, 25],
            // limit: 20,
            id: "deptListTable",
            parseData: function (res) {
                return {
                    "code": 0,
                    "msg": res.message,
                    "count": res.data.total,
                    "data": res.data.list
                }
            },
            cols: [
                [
                    {
                        type: "checkbox",
                        fixed: "left"
                    },
                    {
                        field: 'username',
                        title: '用户名',
                        align: "center"
                    },
                    {
                        field: 'no',
                        title: '工号',
                        align: 'center'
                    },
                    {
                        field: 'department',
                        title: '部门',
                        align: 'center',
                        width: 100
                    },
                    {
                        field: 'status',
                        title: '用户状态',
                        align: 'center',
                        width: 100,
                        templet: function (d) {
                            return d.userStatus == "0" ? "正常使用" : "限制使用";
                        }
                    },
                    {
                        field: 'role',
                        title: '身份',
                        align: 'center',
                        templet: function (d) {
                            if (d.userGrade == "0") {
                                return "系统管理员";
                            } else if (d.userGrade == "1") {
                                return "主任";
                            } else if (d.userGrade == "2") {
                                return "副主任";
                            } else if (d.userGrade == "3") {
                                return "主管";
                            } else if (d.userGrade == "4") {
                                return "普通员工";
                            }
                        }
                    },
                    {
                        field: 'lastLoginTime',
                        title: '最后登录时间',
                        align: 'center'
                    },
                    {
                        field: 'lastLoginIp',
                        title: '最后登录IP地址',
                        align: 'center'
                    },
                    {
                        title: '操作',
                        minWidth: 200,
                        templet: '#deptListBar',
                        fixed: "right",
                        align: "center"
                    }
                ]
            ]
        });

        //搜索【此功能需要后台配合，所以暂时没有动态效果演示】
        $(".search_btn").on("click", function () {
            if ($(".searchVal").val() != '') {
                table.reload("newsListTable", {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: {
                        key: $(".searchVal").val() //搜索的关键字
                    }
                })
            } else {
                layer.msg("请输入搜索的内容");
            }
        });

        //添加用户
        function addDept(edit) {
            var index = layui.layer.open({
                title: "添加部门",
                type: 2,
                area: ['90%', '90%'],
                fixed: false, //不固定
                maxmin: true,
                content: "userAdd.html",
                success: function (layero, index) {
                    var body = layui.layer.getChildFrame('body', index);
                    if (edit) {
                        body.find(".userName").val(edit.userName); //登录名
                        body.find(".userEmail").val(edit.userEmail); //邮箱
                        body.find(".userSex input[value=" + edit.userSex + "]").prop("checked", "checked"); //性别
                        body.find(".userGrade").val(edit.userGrade); //会员等级
                        body.find(".userStatus").val(edit.userStatus); //用户状态
                        body.find(".userDesc").text(edit.userDesc); //用户简介
                        form.render();
                    }
                    setTimeout(function () {
                        layui.layer.tips('点击此处返回部门列表', '.layui-layer-setwin .layui-layer-close', {
                            tips: 3
                        });
                    }, 500)
                }
            })
            //layui.layer.full(index);
            window.sessionStorage.setItem("index", index);
            //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）

        }

        $(".addNews_btn").click(function () {
            addDept();
        })

        //列表操作
        table.on('tool(deptList)', function (obj) {
            var layEvent = obj.event,
                data = obj.data;

            if (layEvent === 'edit') { //编辑
                addUser(data);
            } else if (layEvent === 'usable') { //启用禁用
                var _this = $(this),
                    usableText = "是否确定禁用此部门？",
                    btnText = "已禁用";
                if (_this.text() == "已禁用") {
                    usableText = "是否确定启用此部门？",
                        btnText = "已启用";
                }
                layer.confirm(usableText, {
                    icon: 3,
                    title: '系统提示',
                    cancel: function (index) {
                        layer.close(index);
                    }
                }, function (index) {
                    _this.text(btnText);
                    layer.close(index);
                }, function (index) {
                    layer.close(index);
                });
            } else if (layEvent === 'del') { //删除
                layer.confirm('确定删除此部门？', {
                    icon: 3,
                    title: '提示信息'
                }, function (index) {
                    tableIns.reload();
                    layer.close(index);
                });
            }
        });

    })

</script>
</body>
</html>